name: Build

on: [push, pull_request]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        config:
          - os: "ubuntu-latest"
            cxx-compiler: g++-8
            c-compiler: gcc-8
            build-type: RelWithDebInfo
    runs-on: ${{ matrix.config.os }}

    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-python@v1
      - uses: uraimo/run-on-arch-action@v1.0.5
        id: runcmd
        with:
          architecture: armv6
          distribution: buster
          run: |
            uname -a
            sudo apt-get update
            sudo apt install -y build-essential

            sudo apt-get install "$cxx-compiler" -y
            echo "$cxx-compiler --version"
            sudo apt-get install mysql-client libmysqlclient-dev kwstyle -y
          
            ninja_version=1.9.0
            cmake_version="3.16.2"
            cmake_archive="cmake-$cmake_version-Linux-x86_64"
            wget -q "https://github.com/ninja-build/ninja/releases/download/v$ninja_version/ninja-linux.zip"
            unzip -q ninja-linux.zip -d bin-build
            wget -q "https://github.com/Kitware/CMake/releases/download/v$cmake_version/$cmake_archive.tar.gz"
            tar -xf "$cmake_archive.tar.gz"
          
            chmod +x bin-build/ninja
            chmod +x "$cmake_archive/bin/cmake"
            export PATH=`pwd`/bin-build:$PATH
            export PATH=`pwd`/$cmake_archive/bin:$PATH
            export CXX=$compiler-$version
            export CC=$compiler-$version
      
            cd bin-build
            cmake .. -G Ninja
            cmake --build . --config ${{ matrix.config.build-type }} -- -j 2
            ctest -j2 --output-on-failure --repeat-until-fail 2 -C ${{ matrix.config.build-type }}
